
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =============================================
    // Publicly Readable Collections
    // Allow anyone to read data for doctors, clinics, hospitals, and diagnostics centers.
    // This is necessary for browsing and search pages.
    // Writes are disallowed for public users.
    // =============================================
    
    match /doctors/{doctorId} {
      allow read: if true;
      allow write: if false; // More specific rules needed for doctor/admin writes
    }

    match /clinics/{clinicId} {
      allow read: if true;
      allow write: if false; // More specific rules needed for clinic/admin writes
    }
    
    match /hospitals/{hospitalId} {
      allow read: if true;
      allow write: if false; // More specific rules needed for hospital/admin writes
    }

    match /diagnostics/{centreId} {
      allow read: if true;
      allow write: if false; // More specific rules needed for diagnostics/admin writes
      
      // Allow reading subcollections of diagnostics centres
      match /{allChildren=**} {
        allow read: if true;
      }
    }

    // =============================================
    // User-Specific Collections
    // These collections contain user data and require authentication.
    // =============================================
    
    // Users collection for profiles
    match /users/{userId} {
      // A user can only read or update their own profile.
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // Allow creation of a user document if the user is creating their own.
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // Appointments collection
    match /appointments/{appointmentId} {
      // Allow a user to create an appointment for themselves.
      allow create: if request.auth != null && request.resource.data.patientId == request.auth.uid;

      // Allow a user to read their own appointments.
      // In a real app, you would also allow the relevant doctor/clinic to read this.
      allow read: if request.auth != null && request.auth.uid == resource.data.patientId;
      
      // Allow a user to update their own appointment (e.g., for feedback or status change).
      allow update: if request.auth != null && request.auth.uid == resource.data.patientId;
    }

    // Test Appointments (Diagnostics)
    match /testAppointments/{testAppointmentId} {
       allow create: if request.auth != null && request.resource.data.patientId == request.auth.uid;
       allow read, update: if request.auth != null && request.auth.uid == resource.data.patientId;
    }
  }
}
