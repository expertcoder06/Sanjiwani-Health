
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS COLLECTION
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow delete: if false; // only admin can delete
    }

    // DOCTORS COLLECTION
    match /doctors/{doctorId} {
      allow read: if true; // public profiles
      allow create, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }

    // CLINICS
    match /clinics/{clinicId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }

    // DIAGNOSIS CENTRES
    match /diagnosisCentres/{centreId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }

    // APPOINTMENTS
    match /appointments/{appointmentId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.patientId ||
         request.auth.uid == resource.data.doctorId ||
         request.auth.uid == resource.data.clinicId ||
         request.auth.uid == resource.data.centreId);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.patientId;
      allow update: if request.auth != null &&
        (request.auth.uid == resource.data.patientId ||
         request.auth.uid == resource.data.doctorId);
      allow delete: if false;
    }

    // REPORTS
    match /reports/{reportId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.uploadedBy ||
         request.auth.uid == get(/databases/$(database)/documents/appointments/$(resource.data.appointmentId)).data.patientId);
      allow create: if request.auth != null &&
        (request.auth.uid == resource.data.uploadedBy);
      allow delete: if false;
    }

    // PAYMENTS
    match /payments/{paymentId} {
      allow read, create: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if false; // payments updated only via server-side (Cloud Functions)
      allow delete: if false;
    }

    // ADMIN LOGS (only admin can read/write)
    match /adminLogs/{logId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
  }
}
